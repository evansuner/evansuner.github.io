<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>使用Docker搭建Django应用 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="django_docker_img:v1Django项目v1：使用内置的runserver启动项目树形图: 创建django应用123mkdir mysite &amp;&amp; cd mysitedjango-admin startproject mysite1cd mysite1 修改settings.py文件1234cd mysite1vim settings.pyALLOWED_HOST">
<meta property="og:type" content="article">
<meta property="og:title" content="使用Docker搭建Django应用">
<meta property="og:url" content="http://example.com/2022/01/27/%E4%BD%BF%E7%94%A8Docker%E6%90%AD%E5%BB%BADjango%E5%BA%94%E7%94%A8-shi-yong-docker-da-jian-django-ying-yong/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="django_docker_img:v1Django项目v1：使用内置的runserver启动项目树形图: 创建django应用123mkdir mysite &amp;&amp; cd mysitedjango-admin startproject mysite1cd mysite1 修改settings.py文件1234cd mysite1vim settings.pyALLOWED_HOST">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://mweb-cdn.reidosann.top/mweb/16430634518434-20220125-16430634518443.jpg">
<meta property="og:image" content="https://mweb-cdn.reidosann.top/mweb/16430625778275-20220125-16430625778295.jpg">
<meta property="og:image" content="https://mweb-cdn.reidosann.top/mweb/16430640121348-20220125-16430640121355.jpg">
<meta property="og:image" content="https://mweb-cdn.reidosann.top/mweb/16430745966537-20220125-16430745966545.jpg">
<meta property="og:image" content="https://mweb-cdn.reidosann.top/mweb/20220127-16432403750528.jpg">
<meta property="og:image" content="https://mweb-cdn.reidosann.top/mweb/16430745966537-20220125-16430745966545.jpg">
<meta property="article:published_time" content="2022-01-27T00:32:23.872Z">
<meta property="article:modified_time" content="2022-01-27T00:32:23.872Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="django">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://mweb-cdn.reidosann.top/mweb/16430634518434-20220125-16430634518443.jpg">
  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightBlock(block);
      });
    });
  </script>
  
<link rel="stylesheet" href="/css/index.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body style="


  background-color: #eff0f6

">
  <div id="container">
    <nav id="nav">
  <header class="header">
    <a href="/" class="title">Clover Tuan</a>
  </header>
  <div class="ctnWrap">
    <div class="icons">
      
        
          
            <a href="https://dribbble.com/clovertuan" target="_blank" class="nav-icn iconfont icon-dribbble"></a>
          
        
          
            <a href="https://www.behance.net/clovertuan" target="_blank" class="nav-icn iconfont icon-behance"></a>
          
        
          
            <a href="http://clovertuan.lofter.com/" target="_blank" class="nav-icn iconfont icon-lofter"></a>
          
        
          
            <a href="https://www.instagram.com/clovertuan/" target="_blank" class="nav-icn iconfont icon-instagram"></a>
          
        
          
            <a href="https://github.com/cloverTuan" target="_blank" class="nav-icn iconfont icon-github"></a>
          
        
      
    </div>
    <div class="menu">
      
        
            <a href="/" class="nav-menu ">HOME</a>
          
        
            <a href="/archives" class="nav-menu ">ARCHIVE</a>
          
        
            <a href="/about" class="nav-menu ">ABOUT</a>
          
        
      
    </div>
  </div>
</nav>
    <div id="main"><section class="article">
  <h2 class="title">使用Docker搭建Django应用</h2>
  <p class="sub">Jan 27, 2022</p>
  <article class="content">
    <h2 id="django-docker-img-v1"><a href="#django-docker-img-v1" class="headerlink" title="django_docker_img:v1"></a>django_docker_img:v1</h2><p>Django项目v1：使用内置的runserver启动<br>项目树形图:<br><img src="https://mweb-cdn.reidosann.top/mweb/16430634518434-20220125-16430634518443.jpg" alt="16430634518434"></p>
<h3 id="创建django应用"><a href="#创建django应用" class="headerlink" title="创建django应用"></a>创建django应用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> mysite &amp;&amp; <span class="built_in">cd</span> mysite</span><br><span class="line">django-admin startproject mysite1</span><br><span class="line"><span class="built_in">cd</span> mysite1</span><br></pre></td></tr></table></figure>
<h3 id="修改settings-py文件"><a href="#修改settings-py文件" class="headerlink" title="修改settings.py文件"></a>修改settings.py文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd mysite1</span><br><span class="line">vim settings.py</span><br><span class="line"></span><br><span class="line">ALLOWED_HOSTS = [&#x27;x.x.x.x&#x27;] # 服务器ip地址</span><br></pre></td></tr></table></figure>
<h3 id="创建requirements-txt"><a href="#创建requirements-txt" class="headerlink" title="创建requirements.txt"></a>创建requirements.txt</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line">pip3 freeze &gt; requirements.txt</span><br></pre></td></tr></table></figure>
<h3 id="创建-pip-conf"><a href="#创建-pip-conf" class="headerlink" title="创建 pip.conf"></a>创建 pip.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim pip.conf</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line">index-url=<span class="string">&quot;http://mirrors.cloud.tencent.com/pypi/simple&quot;</span></span><br><span class="line">[install]</span><br><span class="line">trusted-host=<span class="string">&quot;mirrors.cloud.tencent.com&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="创建Dockerfile"><a href="#创建Dockerfile" class="headerlink" title="创建Dockerfile"></a>创建Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim Dockerfile</span><br><span class="line"></span><br><span class="line">FROM python:3.9</span><br><span class="line"><span class="comment"># 设置Python变量环境</span></span><br><span class="line">ENV PYTHONRUNBUFFER 1</span><br><span class="line"><span class="comment"># 设置pip源</span></span><br><span class="line">COPY pip.conf /root/.pip/pip.conf</span><br><span class="line">RUN <span class="built_in">mkdir</span> -p /var/www/html/mysite1</span><br><span class="line">WORKDIR /var/www/html/mysite1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将所有代码加入到容器中</span></span><br><span class="line">ADD . /var/www/html/mysite1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">RUN pip3 install -r requirements.txt</span><br></pre></td></tr></table></figure>
<h3 id="创建镜像-django-docker-img-v1"><a href="#创建镜像-django-docker-img-v1" class="headerlink" title="创建镜像 django_docker_img:v1"></a>创建镜像 <code>django_docker_img:v1</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t django_docker_img:v1 .</span><br></pre></td></tr></table></figure>
<h3 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a>查看镜像</h3><p><img src="https://mweb-cdn.reidosann.top/mweb/16430625778275-20220125-16430625778295.jpg" alt="16430625778275"></p>
<h3 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 服务器安全组需要先将5000端口打开</span></span><br><span class="line">docker run -itd --name mysite1 -p 5000:8000 django_docker_img:v1</span><br></pre></td></tr></table></figure>
<h3 id="启动django项目"><a href="#启动django项目" class="headerlink" title="启动django项目"></a>启动django项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysite1 bash</span><br><span class="line"><span class="comment">## 启动项目</span></span><br><span class="line">python3 manage.py makemigrations</span><br><span class="line">python3 manage.py migrates</span><br><span class="line">python3 manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>
<p>接下来就可以在浏览器通过服务器外网ip+端口号访问了 <code>x.x.x.x:5000</code></p>
<h2 id="django-docker-img-v2"><a href="#django-docker-img-v2" class="headerlink" title="django_docker_img:v2"></a>django_docker_img:v2</h2><p>基于v1版本，加入uwsgi配置<br>项目树形图：</p>
<p><img src="https://mweb-cdn.reidosann.top/mweb/16430640121348-20220125-16430640121355.jpg" alt="16430640121348"></p>
<h3 id="v2的Dockerfile"><a href="#v2的Dockerfile" class="headerlink" title="v2的Dockerfile"></a>v2的Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9</span><br><span class="line">ENV PYTHONUNBUFFERED 1</span><br><span class="line">COPY pip.conf /root/.pip/pip.conf</span><br><span class="line">RUN <span class="built_in">mkdir</span> -p /var/www/html/mysite2</span><br><span class="line">WORKDIR /var/www/html/mysite2</span><br><span class="line">ADD . /var/www/html/mysite2</span><br><span class="line">RUN pip3 install -r requirements.txt</span><br><span class="line"><span class="comment"># 消除unix环境下换行\n+回车\r问题</span></span><br><span class="line">RUN sed -i <span class="string">&#x27;s/\r//&#x27;</span> ./start.sh</span><br><span class="line">RUN <span class="built_in">chmod</span> +x ./start.sh</span><br></pre></td></tr></table></figure>
<h3 id="编写start-sh"><a href="#编写start-sh" class="headerlink" title="编写start.sh"></a>编写start.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">python3 manage.py makemigrations &amp;&amp;</span><br><span class="line">python3 manage.py migrate &amp;&amp;</span><br><span class="line">uwsgi --ini /var/www/html/mysite2/uwsgi.ini</span><br></pre></td></tr></table></figure>
<h3 id="编写uwsgi-ini"><a href="#编写uwsgi-ini" class="headerlink" title="编写uwsgi.ini"></a>编写uwsgi.ini</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line">http= 0.0.0.0:8000 <span class="comment"># 因为部署在服务器上，本地访问，所以不能使用127.0.0.1</span></span><br><span class="line"><span class="built_in">chdir</span> = ../mysite2</span><br><span class="line">module = mysite2.wsgi:application</span><br><span class="line">vacuum=True</span><br><span class="line">master = True</span><br><span class="line">max-requests=5000</span><br><span class="line">buffer-size = 65536</span><br><span class="line">daemonize=./mysite2.<span class="built_in">log</span></span><br><span class="line">processes=5</span><br><span class="line"><span class="comment"># 请求超时时间 秒</span></span><br><span class="line"><span class="comment"># harakiri=60</span></span><br><span class="line"><span class="comment"># 当一个请求被harakiri杀掉时,输出一条日志</span></span><br><span class="line"><span class="comment"># harakiri-verbose=true</span></span><br></pre></td></tr></table></figure>
<h3 id="创建镜像，启动容器，启动服务"><a href="#创建镜像，启动容器，启动服务" class="headerlink" title="创建镜像，启动容器，启动服务"></a>创建镜像，启动容器，启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker build -t django_docker_img:v2</span><br><span class="line">docker run -itd --name mysite2 -p 5000:8000 django_docker_img:v2</span><br><span class="line">sh ./start.sh</span><br></pre></td></tr></table></figure>
<p>浏览器访问<code>x.x.x.x:5000</code>，此时使用的是uwsgi启动的服务。</p>
<h2 id="django-docker-img-v3"><a href="#django-docker-img-v3" class="headerlink" title="django_docker_img:v3"></a>django_docker_img:v3</h2><p>使用双容器部署 <code>Django + uwsgi + Nginx</code><br>基于v2版本加入Nginx配置<br>项目树形图：   </p>
<p>![16431134649959](<a target="_blank" rel="noopener" href="https://mweb-cdn.reidosann.top/mweb/20220125-16431134649968.jpg">https://mweb-cdn.reidosann.top/mweb/20220125-16431134649968.jpg</a><br><img src="https://mweb-cdn.reidosann.top/mweb/16430745966537-20220125-16430745966545.jpg" alt="16430745966537"></p>
<h3 id="修改settings-py"><a href="#修改settings-py" class="headerlink" title="修改settings.py"></a>修改settings.py</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx采用动静分离，所以必须要在settings中配置MEDIA_ROOT和STATIC_ROOT</span></span><br><span class="line">STATIC_ROOT = os.path.join(BASE_DIR,<span class="string">&#x27;static&#x27;</span>)</span><br><span class="line">STATIC_URL = <span class="string">&quot;/static/&quot;</span></span><br><span class="line"></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR,<span class="string">&#x27;media&#x27;</span>)</span><br><span class="line">MEDIA_URL = <span class="string">&quot;/media/&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="Django-Dockerfile"><a href="#Django-Dockerfile" class="headerlink" title="Django Dockerfile"></a>Django Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9</span><br><span class="line">ENV PYTHONUNBUFFERED 1</span><br><span class="line">COPY pip.conf /root/.pip/pip.conf</span><br><span class="line">RUN <span class="built_in">mkdir</span> -p /var/www/html/mysite3</span><br><span class="line">WORKDIR /var/www/html/mysite3</span><br><span class="line">ADD . /var/www/html/mysite3</span><br><span class="line">RUN pip3 install -r requirements.txt</span><br><span class="line"><span class="comment"># 消除unix环境下换行\n+回车\r问题</span></span><br><span class="line">RUN sed -i <span class="string">&#x27;s/\r//&#x27;</span> ./start.sh</span><br><span class="line">RUN <span class="built_in">chmod</span> +x ./start.sh</span><br></pre></td></tr></table></figure>

<h3 id="修改start-sh"><a href="#修改start-sh" class="headerlink" title="修改start.sh"></a>修改start.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 收集静态文件</span></span><br><span class="line">python3 manage.py collectstatic --noinput &amp;&amp;</span><br><span class="line">python3 manage.py makemigrations &amp;&amp;</span><br><span class="line">python3 manage.py migrate &amp;&amp;</span><br><span class="line">uwsgi --ini /var/www/html/mysite3/uwsgi.ini</span><br></pre></td></tr></table></figure>

<h3 id="修改uwsgi-ini"><a href="#修改uwsgi-ini" class="headerlink" title="修改uwsgi.ini"></a>修改uwsgi.ini</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"><span class="comment"># 因为需要与nginx之间进行通信，所以将http改为socket</span></span><br><span class="line">socket= 0.0.0.0:8000 <span class="comment"># 因为部署在服务器上，本地访问，所以不能使用127.0.0.1</span></span><br><span class="line"><span class="built_in">chdir</span> = ../mysite3</span><br><span class="line">module = mysite3.wsgi:application</span><br><span class="line">vacuum=True</span><br><span class="line">master = True</span><br><span class="line">max-requests=5000</span><br><span class="line">buffer-size = 65536</span><br><span class="line">daemonize=./mysite3.<span class="built_in">log</span></span><br><span class="line">processes=5</span><br></pre></td></tr></table></figure>
<h3 id="创建镜像，启动容器"><a href="#创建镜像，启动容器" class="headerlink" title="创建镜像，启动容器"></a>创建镜像，启动容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t django_docker_img:v3 .</span><br><span class="line">docker run -itd --name mysite3 -p 5000:8000 django_docker_img:v3</span><br></pre></td></tr></table></figure>

<h3 id="编写nginx镜像-Dockerfile"><a href="#编写nginx镜像-Dockerfile" class="headerlink" title="编写nginx镜像 Dockerfile"></a>编写nginx镜像 Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">rm</span> /etc/nginx/conf.d/default.conf \</span><br><span class="line">&amp;&amp; <span class="built_in">mkdir</span> -p /usr/local/share/nginx/html/static \</span><br><span class="line">&amp;&amp; <span class="built_in">mkdir</span> -p /usr/local/share/nginx/html/media \</span><br><span class="line">&amp;&amp; <span class="built_in">mkdir</span> -p /usr/local/share/nginx/html/ssl</span><br><span class="line"></span><br><span class="line">ADD ./nginx.conf /etc/nginx/conf.d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭守护模式</span></span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="编写nginx-conf"><a href="#编写nginx-conf" class="headerlink" title="编写nginx.conf"></a>编写nginx.conf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">upstream django &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 172.18.0.2:8000; <span class="comment"># 这里ip使用 docker inspect mysite3 | grep &quot;IPAddress&quot; 查看</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location /static &#123;</span><br><span class="line">        <span class="built_in">alias</span> /usr/share/nginx/html/static;</span><br><span class="line">    &#125;</span><br><span class="line">    location /media &#123;</span><br><span class="line">        <span class="built_in">alias</span> /usr/local/share/nginx/html/media;</span><br><span class="line">    &#125;</span><br><span class="line">    location / &#123;</span><br><span class="line">        include /etc/nginx/uwsgi_params;</span><br><span class="line">        uwsgi_pass django;</span><br><span class="line">        uwsgi_read_timeout 600;</span><br><span class="line">        uwsgi_connect_timeout 600;</span><br><span class="line">        uwsgi_send_timeout 600;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    access_log /var/log/nginx/access.log main;</span><br><span class="line">    error_log /var/log/nginx/error.log warn;</span><br></pre></td></tr></table></figure>

<h3 id="创建nginx镜像并启动"><a href="#创建nginx镜像并启动" class="headerlink" title="创建nginx镜像并启动"></a>创建nginx镜像并启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker build -t mynginx:v1 .</span><br><span class="line">docker run -itd --name mysite3-nginx \</span><br><span class="line">-v ~/mysite3path/static:/usr/local/share/nginx/html/static \</span><br><span class="line">-v ~/mysite3path/media:/usr/local/share/nginx/html/media \</span><br><span class="line">-v ~/mysite3path/ssl:/usr/local/share/nginx/html/ssl \</span><br><span class="line">-p 8000:80 \</span><br><span class="line">mynginx:v1</span><br></pre></td></tr></table></figure>
<h3 id="进入django容器，启动uwsgi服务"><a href="#进入django容器，启动uwsgi服务" class="headerlink" title="进入django容器，启动uwsgi服务"></a>进入django容器，启动uwsgi服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysite3 bash start.sh</span><br></pre></td></tr></table></figure>
<p>接下来访问<code>x.x.x.x:5000</code>服务就是经过uwsgi启动，nginx转发的服务了。</p>
<h2 id="django-docker-img-v4"><a href="#django-docker-img-v4" class="headerlink" title="django_docker_img:v4"></a>django_docker_img:v4</h2><p>利用<code>docker-compose</code>部署<code>Django+uwsgi+nginx+mysql+redis</code></p>
<ul>
<li>Django + uwsgi容器：核心应用程序，处理动态请求</li>
<li>MySQL容器：数据库服务器</li>
<li>Redis容器：缓存服务</li>
<li>Nginx容器：反向代理并处理静态资源请求</li>
</ul>
<p>依赖关系：<br>Django+uwsgi依赖redis容器和mysql容器，nginx容器依赖django+uwsgi容器   </p>
<p>图示关系：<br><img src="https://mweb-cdn.reidosann.top/mweb/20220127-16432403750528.jpg" alt="container_relies"><br>项目树形图：<br><img src="https://mweb-cdn.reidosann.top/mweb/16430745966537-20220125-16430745966545.jpg" alt="16430745966537"></p>
<h3 id="编写docker-compose-yml"><a href="#编写docker-compose-yml" class="headerlink" title="编写docker-compose.yml"></a>编写docker-compose.yml</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&quot;3&quot;</span></span><br><span class="line"></span><br><span class="line">volumes: <span class="comment"># 自定义数据卷，位于宿主机/var/lib/docker/volumes内</span></span><br><span class="line">  mysite4_db_vol: <span class="comment"># 定义数据卷同步容器内mysql数据</span></span><br><span class="line">  mysite4_redis_vol: <span class="comment"># 定义数据卷同步redis容器内数据</span></span><br><span class="line">  mysite4_media_vol: <span class="comment"># 定义数据卷同步media文件夹数据</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  redis:</span><br><span class="line">    image: redis:5</span><br><span class="line">    <span class="built_in">command</span>: redis-server /etc/redis/redis.conf <span class="comment"># 容器启动后启动redis服务器</span></span><br><span class="line">    volumes:</span><br><span class="line">      - mysite4_redis_vol:/data <span class="comment"># 通过挂载给redis数据备份</span></span><br><span class="line">      - ./compose/redis/redis.conf:/etc/redis/redis.conf <span class="comment"># 挂载redis配置文件</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    restart: always <span class="comment"># always表容器运行发生错误时一直重启</span></span><br><span class="line"></span><br><span class="line">  db:</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=123456 <span class="comment"># 数据库密码</span></span><br><span class="line">      - MYSQL_DATABASE=mysite4 <span class="comment"># 数据库名称</span></span><br><span class="line">      - MYSQL_USER=dbuser <span class="comment"># 数据库用户名</span></span><br><span class="line">      - MYSQL_PASSWORD=password <span class="comment"># 用户密码</span></span><br><span class="line"></span><br><span class="line">    volumes:</span><br><span class="line">      - mysite4_db_vol:/var/lib/mysql:rw <span class="comment"># 挂载数据库数据, 可读可写</span></span><br><span class="line">      - ./compose/mysql/conf/my.cnf:/etc/mysql/my.cnf <span class="comment"># 挂载配置文件</span></span><br><span class="line">      - ./compose/mysql/init:/docker-entrypoint-initdb.d/ <span class="comment"># 挂载数据初始化sql脚本</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;3306:3306&quot;</span> <span class="comment"># 与配置文件保持一致</span></span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  web:</span><br><span class="line">    build: ./mysite4 <span class="comment"># 使用mysite4目录下的Dockerfile</span></span><br><span class="line">    expose:</span><br><span class="line">      - <span class="string">&quot;8000&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./mysite4:/var/www/html/mysite4 <span class="comment"># 挂载项目代码</span></span><br><span class="line">      - mysite4_media_vol:/var/www/html/mysite4/media <span class="comment"># 以数据卷挂载容器内用户上传媒体文件</span></span><br><span class="line">      - ./compose/uwsgi:/tmp <span class="comment"># 挂载uwsgi日志</span></span><br><span class="line">    links:</span><br><span class="line">      - db</span><br><span class="line">      - redis</span><br><span class="line">    depends_on: <span class="comment"># 依赖关系</span></span><br><span class="line">      - db</span><br><span class="line">      - redis</span><br><span class="line">    environment:</span><br><span class="line">      - DEBUG=False</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">tty</span>: <span class="literal">true</span></span><br><span class="line">    stdin_open: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  nginx:</span><br><span class="line">    build: ./compose/nginx</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      - <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    expose:</span><br><span class="line">      - <span class="string">&quot;80&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./mysite4/static:/usr/share/nginx/html/static <span class="comment"># 挂载静态文件</span></span><br><span class="line">      - ./compose/nginx/ssl:/usr/share/nginx/ssl <span class="comment"># 挂载ssl证书目录</span></span><br><span class="line">      - ./compose/nginx/log:/var/log/nginx <span class="comment"># 挂载日志</span></span><br><span class="line">      - mysite4_media_vol:/usr/share/nginx/html/media <span class="comment"># 挂载用户上传媒体文件</span></span><br><span class="line">    links:</span><br><span class="line">      - web</span><br><span class="line">    depends_on:</span><br><span class="line">      - web</span><br><span class="line">    restart: always</span><br></pre></td></tr></table></figure>
<h3 id="编写-django-uwsgi镜像Dockerfile"><a href="#编写-django-uwsgi镜像Dockerfile" class="headerlink" title="编写 django+uwsgi镜像Dockerfile"></a>编写 django+uwsgi镜像Dockerfile</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.9</span><br><span class="line">ENV PYTHONUNBUFFERED 1</span><br><span class="line">COPY pip.conf /root/.pip/pip.conf</span><br><span class="line">RUN <span class="built_in">mkdir</span> -p /var/www/html/mysite4</span><br><span class="line">WORKDIR /var/www/html/mysite4</span><br><span class="line">ADD . /var/www/html/mysite4</span><br><span class="line">RUN pip3 install --upgrade pip</span><br><span class="line">RUN pip3 install -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 消除unix环境下换行\n+回车\r问题</span></span><br><span class="line">RUN sed -i <span class="string">&#x27;s/\r//&#x27;</span> ./start.sh</span><br><span class="line">RUN <span class="built_in">chmod</span> +x ./start.sh</span><br></pre></td></tr></table></figure>
<h3 id="requirements-txt内容"><a href="#requirements-txt内容" class="headerlink" title="requirements.txt内容"></a>requirements.txt内容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Django==3.0.5</span><br><span class="line">django-redis==5.2.0</span><br><span class="line">PyMySQL==1.0.2</span><br><span class="line">redis==4.1.1</span><br><span class="line">uWSGI==2.0.20</span><br></pre></td></tr></table></figure>

<h3 id="编写start-sh脚本"><a href="#编写start-sh脚本" class="headerlink" title="编写start.sh脚本"></a>编写start.sh脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">python3 manage.py collectstatic --noinput &amp;&amp;</span><br><span class="line">python3 manage.py makemigrations &amp;&amp;</span><br><span class="line">python3 manage.py migrate &amp;&amp;</span><br><span class="line">uwsgi --ini /var/www/html/mysite4/uwsgi.ini</span><br></pre></td></tr></table></figure>

<h3 id="编写uwsgi-ini配置文件"><a href="#编写uwsgi-ini配置文件" class="headerlink" title="编写uwsgi.ini配置文件"></a>编写uwsgi.ini配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"></span><br><span class="line">socket= 0.0.0.0:8000</span><br><span class="line"><span class="built_in">chdir</span> = ../mysite4</span><br><span class="line">module = mysite4.wsgi:application</span><br><span class="line">vacuum=True</span><br><span class="line">master = True</span><br><span class="line">max-requests=5000</span><br><span class="line">buffer-size = 65536</span><br><span class="line">daemonize=./mysite4.<span class="built_in">log</span></span><br><span class="line">processes=5</span><br></pre></td></tr></table></figure>
<h3 id="编写nginx镜像文件"><a href="#编写nginx镜像文件" class="headerlink" title="编写nginx镜像文件"></a>编写nginx镜像文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:latest</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">rm</span> /etc/nginx/conf.d/default.conf \</span><br><span class="line">&amp;&amp; <span class="built_in">mkdir</span> -p /usr/local/share/nginx/html/static \</span><br><span class="line">&amp;&amp; <span class="built_in">mkdir</span> -p /usr/local/share/nginx/html/media \</span><br><span class="line">&amp;&amp; <span class="built_in">mkdir</span> -p /usr/local/share/nginx/html/ssl</span><br><span class="line"></span><br><span class="line">ADD ./nginx.conf /etc/nginx/conf.d</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="编写nginx配置文件"><a href="#编写nginx配置文件" class="headerlink" title="编写nginx配置文件"></a>编写nginx配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">upstream django &#123;</span><br><span class="line">        ip_hash;</span><br><span class="line">        server web:8000;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    location /static &#123;</span><br><span class="line">        <span class="built_in">alias</span> /usr/local/share/nginx/html/static;</span><br><span class="line">    &#125;</span><br><span class="line">    location /media &#123;</span><br><span class="line">        <span class="built_in">alias</span> /usr/local/share/nginx/html/media;</span><br><span class="line">    &#125;</span><br><span class="line">    location / &#123;</span><br><span class="line">        include /etc/nginx/uwsgi_params;</span><br><span class="line">        uwsgi_pass django;</span><br><span class="line">        uwsgi_read_timeout 600;</span><br><span class="line">        uwsgi_connect_timeout 600;</span><br><span class="line">        uwsgi_send_timeout 600;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header X-Real-IP  <span class="variable">$remote_addr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    access_log /var/log/nginx/access.log main;</span><br><span class="line">    error_log  /var/log/nginx/error.log warn;</span><br><span class="line">    </span><br><span class="line">    server_token off;</span><br></pre></td></tr></table></figure>

<h3 id="编写MySQL容器配置文件"><a href="#编写MySQL容器配置文件" class="headerlink" title="编写MySQL容器配置文件"></a>编写MySQL容器配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># compose/mysql/conf/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line">character-set-server=utf8</span><br><span class="line"></span><br><span class="line">port            = 3306 <span class="comment"># 端口与docker-compose里映射端口保持一致</span></span><br><span class="line"><span class="comment">#bind-address= localhost #一定要注释掉，mysql所在容器和django所在容器不同IP</span></span><br><span class="line"></span><br><span class="line">basedir         = /usr</span><br><span class="line">datadir         = /var/lib/mysql</span><br><span class="line">tmpdir          = /tmp</span><br><span class="line">pid-file        = /var/run/mysqld/mysqld.pid</span><br><span class="line">socket          = /var/run/mysqld/mysqld.sock</span><br><span class="line">skip-name-resolve  <span class="comment"># 这个参数是禁止域名解析的，远程访问推荐开启skip_name_resolve。</span></span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">default-character-set=utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br><span class="line">default-character-set=utf8</span><br></pre></td></tr></table></figure>

<h3 id="编写MySQL启动时执行的脚本"><a href="#编写MySQL启动时执行的脚本" class="headerlink" title="编写MySQL启动时执行的脚本"></a>编写MySQL启动时执行的脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># compose/mysql/init/init.sql</span></span><br><span class="line">GRANT ALL PRIVILEGES ON mysite4.* TO dbuser@<span class="string">&quot;%&quot;</span> IDENTIFIED BY <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>

<h3 id="编写redis容器配置文件"><a href="#编写redis容器配置文件" class="headerlink" title="编写redis容器配置文件"></a>编写redis容器配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># compose/redis/redis.conf</span></span><br><span class="line"><span class="comment"># Redis 5配置文件下载地址</span></span><br><span class="line"><span class="comment"># https://raw.githubusercontent.com/antirez/redis/5.0/redis.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 请注释掉下面一行，变成#bind 127.0.0.1,这样其它机器或容器也可访问</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 取消下行注释，给redis设置登录密码。这个密码django settings.py会用到。</span></span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure>
<h3 id="修改django项目中的settings-py"><a href="#修改django项目中的settings-py" class="headerlink" title="修改django项目中的settings.py"></a>修改django项目中的settings.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生产环境设置 Debug = False</span></span><br><span class="line">Debug = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置ALLOWED HOSTS</span></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&#x27;your_server_IP&#x27;</span>, <span class="string">&#x27;your_domain_name&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置STATIC ROOT 和 STATIC URL</span></span><br><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;static&#x27;</span>)</span><br><span class="line">STATIC_URL = <span class="string">&quot;/static/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置MEDIA ROOT 和 MEDIA URL</span></span><br><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">&#x27;media&#x27;</span>)</span><br><span class="line">MEDIA_URL = <span class="string">&quot;/media/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置数据库。这里用户名和密码必需和docker-compose.yml里mysql环境变量保持一致</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;mysite4&#x27;</span>, <span class="comment"># 数据库名</span></span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>:<span class="string">&#x27;dbuser&#x27;</span>, <span class="comment"># 你设置的用户名 - 非root用户</span></span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>:<span class="string">&#x27;123456&#x27;</span>, <span class="comment"># # 换成你自己密码</span></span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;db&#x27;</span>, <span class="comment"># 注意：这里使用的是db别名，docker会自动解析成ip</span></span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>:<span class="string">&#x27;3306&#x27;</span>, <span class="comment"># 端口</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置redis缓存。这里密码为redis.conf里设置的密码</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;django_redis.cache.RedisCache&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LOCATION&quot;</span>: <span class="string">&quot;redis://redis:6379/1&quot;</span>, <span class="comment">#这里直接使用redis别名作为host ip地址</span></span><br><span class="line">        <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;CLIENT_CLASS&quot;</span>: <span class="string">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class="line">            <span class="string">&quot;PASSWORD&quot;</span>: <span class="string">&quot;123456&quot;</span>, <span class="comment"># 换成你自己密码</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用Docker-compose构建镜像并启动"><a href="#使用Docker-compose构建镜像并启动" class="headerlink" title="使用Docker-compose构建镜像并启动"></a>使用Docker-compose构建镜像并启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br><span class="line"><span class="comment">## 检查images是否成功构建</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment">## 启动</span></span><br><span class="line">docker-compose up</span><br><span class="line"><span class="comment">## 查看启动的容器</span></span><br><span class="line">docker ps </span><br></pre></td></tr></table></figure>
<h3 id="进入web容器执行start-sh脚本运行uwsgi服务"><a href="#进入web容器执行start-sh脚本运行uwsgi服务" class="headerlink" title="进入web容器执行start.sh脚本运行uwsgi服务"></a>进入web容器执行start.sh脚本运行uwsgi服务</h3><p>如果上一步启动容器没有任何问题的话，就可以执行以下操作了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysite4 bash start.sh</span><br></pre></td></tr></table></figure>
<p>接下来访问<code>x.x.x.x:8000</code>就可以看到上线的项目了。</p>

  </article>
  <footer class="f-cf">
    
      <a href="/2022/01/28/Family%20matters-familymatters/" class="link f-fl">⟵Family matters</a>
    
    
      <a href="/2022/01/27/Suggesting%20and%20recommending%20food-suggestingandrecommendingfood/" class="link f-fr">Suggesting and recommending food⟶</a>
    
  </footer>
</section></div>
    <footer id="footer" class="f-cf">
  d.guangying@foxmail.com
  
    
      
        · <a href="https://dribbble.com/clovertuan" target="_blank" class="nav-icn">Dribbble</a>
      
    
      
        · <a href="https://www.behance.net/clovertuan" target="_blank" class="nav-icn">Behance</a>
      
    
      
        · <a href="http://clovertuan.lofter.com/" target="_blank" class="nav-icn">Lofter</a>
      
    
      
        · <a href="https://www.instagram.com/clovertuan/" target="_blank" class="nav-icn">Instagram</a>
      
    
      
        · <a href="https://github.com/cloverTuan" target="_blank" class="nav-icn">GitHub</a>
      
    
  
  <span class="copyright">All rights reserved @Clover Tuan</span>
</footer>
  </div>
</body>
</html>