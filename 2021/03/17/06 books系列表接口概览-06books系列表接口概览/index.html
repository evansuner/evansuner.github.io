<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>06 books系列表接口概览 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1. books系列表接口1234567# urls.pyfrom django.urls import path,re_pathfrom api import viewsurlpatterns &#x3D; [    path(&amp;#x27;books&#x2F;&amp;#x27;, views.BookAPIView.as_view()),    re_path(&amp;#x27;books&#x2F;(?P&lt;pk&gt;\d+)">
<meta property="og:type" content="article">
<meta property="og:title" content="06 books系列表接口概览">
<meta property="og:url" content="http://example.com/2021/03/17/06%20books%E7%B3%BB%E5%88%97%E8%A1%A8%E6%8E%A5%E5%8F%A3%E6%A6%82%E8%A7%88-06books%E7%B3%BB%E5%88%97%E8%A1%A8%E6%8E%A5%E5%8F%A3%E6%A6%82%E8%A7%88/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. books系列表接口1234567# urls.pyfrom django.urls import path,re_pathfrom api import viewsurlpatterns &#x3D; [    path(&amp;#x27;books&#x2F;&amp;#x27;, views.BookAPIView.as_view()),    re_path(&amp;#x27;books&#x2F;(?P&lt;pk&gt;\d+)">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-03-16T19:17:16.000Z">
<meta property="article:modified_time" content="2021-11-09T00:18:35.235Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="django">
<meta name="twitter:card" content="summary">
  
  <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
  <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightBlock(block);
      });
    });
  </script>
  
<link rel="stylesheet" href="/css/index.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body style="


  background-color: #eff0f6

">
  <div id="container">
    <nav id="nav">
  <header class="header">
    <a href="/" class="title">Clover Tuan</a>
  </header>
  <div class="ctnWrap">
    <div class="icons">
      
        
          
            <a href="https://dribbble.com/clovertuan" target="_blank" class="nav-icn iconfont icon-dribbble"></a>
          
        
          
            <a href="https://www.behance.net/clovertuan" target="_blank" class="nav-icn iconfont icon-behance"></a>
          
        
          
            <a href="http://clovertuan.lofter.com/" target="_blank" class="nav-icn iconfont icon-lofter"></a>
          
        
          
            <a href="https://www.instagram.com/clovertuan/" target="_blank" class="nav-icn iconfont icon-instagram"></a>
          
        
          
            <a href="https://github.com/cloverTuan" target="_blank" class="nav-icn iconfont icon-github"></a>
          
        
      
    </div>
    <div class="menu">
      
        
            <a href="/" class="nav-menu ">HOME</a>
          
        
            <a href="/archives" class="nav-menu ">ARCHIVE</a>
          
        
            <a href="/about" class="nav-menu ">ABOUT</a>
          
        
      
    </div>
  </div>
</nav>
    <div id="main"><section class="article">
  <h2 class="title">06 books系列表接口概览</h2>
  <p class="sub">Mar 17, 2021</p>
  <article class="content">
    <h2 id="1-books系列表接口"><a href="#1-books系列表接口" class="headerlink" title="1. books系列表接口"></a>1. books系列表接口</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;books/&#x27;</span>, views.BookAPIView.as_view()),</span><br><span class="line">    re_path(<span class="string">&#x27;books/(?P&lt;pk&gt;\d+)&#x27;</span>, views.BookAPIView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span>  rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="keyword">from</span> api.ser <span class="keyword">import</span> BookModelSerializer</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookAPIView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span><br><span class="line">        <span class="comment">#查询单个和查询所有，合到一起</span></span><br><span class="line">        <span class="comment"># 查所有</span></span><br><span class="line">        book_list=models.Book.objects.<span class="built_in">all</span>().<span class="built_in">filter</span>(is_delete=<span class="literal">False</span>)</span><br><span class="line">        book_list_ser=BookModelSerializer(book_list,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(data=book_list_ser.data)</span><br><span class="line">        <span class="comment">#查一个</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self,request,*args,**kwargs</span>):</span><br><span class="line">        <span class="comment"># 具备增单条，和增多条的功能</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(request.data,<span class="built_in">dict</span>):</span><br><span class="line"></span><br><span class="line">            book_ser=BookModelSerializer(data=request.data)</span><br><span class="line">            book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            book_ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(data=book_ser.data)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(request.data,<span class="built_in">list</span>):</span><br><span class="line">            <span class="comment">#现在book_ser是ListSerializer对象</span></span><br><span class="line">            <span class="keyword">from</span> rest_framework.serializers <span class="keyword">import</span> ListSerializer</span><br><span class="line">            book_ser = BookModelSerializer(data=request.data,many=<span class="literal">True</span>)  <span class="comment">#增多条</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;--------&#x27;</span>,<span class="built_in">type</span>(book_ser))</span><br><span class="line">            book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            book_ser.save()</span><br><span class="line">            <span class="comment"># 新增---》ListSerializer--》create方法</span></span><br><span class="line">            <span class="comment"># def create(self, validated_data):</span></span><br><span class="line">            <span class="comment">#   self.child是BookModelSerializer对象</span></span><br><span class="line">            <span class="comment">#   print(type(self.child))</span></span><br><span class="line">            <span class="comment">#     return [</span></span><br><span class="line">            <span class="comment">#         self.child.create(attrs) for attrs in validated_data</span></span><br><span class="line">            <span class="comment">#     ]</span></span><br><span class="line">            <span class="keyword">return</span> Response(data=book_ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self,request,*args,**kwargs</span>):</span><br><span class="line">        <span class="comment"># 改一个，改多个</span></span><br><span class="line">        <span class="comment">#改一个个</span></span><br><span class="line">        <span class="keyword">if</span> kwargs.get(<span class="string">&#x27;pk&#x27;</span>,<span class="literal">None</span>):</span><br><span class="line">            book=models.Book.objects.<span class="built_in">filter</span>(pk=kwargs.get(<span class="string">&#x27;pk&#x27;</span>)).first()</span><br><span class="line">            book_ser = BookModelSerializer(instance=book,data=request.data,partial=<span class="literal">True</span>)  <span class="comment"># 增多条</span></span><br><span class="line">            book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            book_ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(data=book_ser.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment">#改多个,</span></span><br><span class="line">            <span class="comment"># 前端传递数据格式[&#123;id:1,name:xx,price:xx&#125;,&#123;id:1,name:xx,price:xx&#125;]</span></span><br><span class="line">            <span class="comment"># 处理传入的数据  对象列表[book1，book2]  修改的数据列表[&#123;name:xx,price:xx&#125;,&#123;name:xx,price:xx&#125;]</span></span><br><span class="line">            book_list=[]</span><br><span class="line">            modify_data=[]</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> request.data:</span><br><span class="line">                <span class="comment">#&#123;id:1,name:xx,price:xx&#125;</span></span><br><span class="line"></span><br><span class="line">                pk=item.pop(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">                book=models.Book.objects.get(pk=pk)</span><br><span class="line">                book_list.append(book)</span><br><span class="line">                modify_data.append(item)</span><br><span class="line">            <span class="comment"># 第一种方案，for循环一个一个修改</span></span><br><span class="line">            <span class="comment">#把这个实现</span></span><br><span class="line">            <span class="comment"># for i,si_data in enumerate(modify_data):</span></span><br><span class="line">            <span class="comment">#     book_ser = BookModelSerializer(instance=book_list[i], data=si_data)</span></span><br><span class="line">            <span class="comment">#     book_ser.is_valid(raise_exception=True)</span></span><br><span class="line">            <span class="comment">#     book_ser.save()</span></span><br><span class="line">            <span class="comment"># return Response(data=&#x27;成功&#x27;)</span></span><br><span class="line">            <span class="comment"># 第二种方案，重写ListSerializer的update方法</span></span><br><span class="line">            book_ser = BookModelSerializer(instance=book_list,data=modify_data,many=<span class="literal">True</span>)</span><br><span class="line">            book_ser.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">            book_ser.save()  <span class="comment">#ListSerializer的update方法,自己写的update方法</span></span><br><span class="line">            <span class="keyword">return</span> Response(book_ser.data)</span><br><span class="line">            <span class="comment"># request.data</span></span><br><span class="line">            <span class="comment">#</span></span><br><span class="line">            <span class="comment"># book_ser=BookModelSerializer(data=request.data)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self,request,*args,**kwargs</span>):</span><br><span class="line">        <span class="comment">#单个删除和批量删除</span></span><br><span class="line">        pk=kwargs.get(<span class="string">&#x27;pk&#x27;</span>)</span><br><span class="line">        pks=[]</span><br><span class="line">        <span class="keyword">if</span> pk:</span><br><span class="line">            <span class="comment"># 单条删除</span></span><br><span class="line">            pks.append(pk)</span><br><span class="line">        <span class="comment">#不管单条删除还是多条删除，都用多条删除</span></span><br><span class="line">        <span class="comment">#多条删除</span></span><br><span class="line">        <span class="comment"># &#123;&#x27;pks&#x27;:[1,2,3]&#125;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pks=request.data.get(<span class="string">&#x27;pks&#x27;</span>)</span><br><span class="line">        <span class="comment">#把is_delete设置成true</span></span><br><span class="line">        <span class="comment"># ret返回受影响的行数</span></span><br><span class="line">        ret=models.Book.objects.<span class="built_in">filter</span>(pk__in=pks,is_delete=<span class="literal">False</span>).update(is_delete=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">if</span> ret:</span><br><span class="line">            <span class="keyword">return</span> Response(data=&#123;<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;删除成功&#x27;</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(data=&#123;<span class="string">&#x27;msg&#x27;</span>: <span class="string">&#x27;没有要删除的数据&#x27;</span>&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">ser.py</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> api <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#写一个类，继ListSerializer,重写update</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookListSerializer</span>(serializers.ListSerializer):</span><br><span class="line">    <span class="comment"># def create(self, validated_data):</span></span><br><span class="line">    <span class="comment">#     print(validated_data)</span></span><br><span class="line">    <span class="comment">#     return super().create(validated_data)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, instance, validated_data</span>):</span><br><span class="line">        <span class="built_in">print</span>(instance)</span><br><span class="line">        <span class="built_in">print</span>(validated_data)</span><br><span class="line">        <span class="comment"># 保存数据</span></span><br><span class="line">        <span class="comment"># self.child:是BookModelSerializer对象</span></span><br><span class="line">        <span class="comment"># ll=[]</span></span><br><span class="line">        <span class="comment"># for i,si_data in enumerate(validated_data):</span></span><br><span class="line">        <span class="comment">#     ret=self.child.update(instance[i],si_data)</span></span><br><span class="line">        <span class="comment">#     ll.append(ret)</span></span><br><span class="line">        <span class="comment"># return ll</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="comment"># self.child.update(对象，字典) for attrs in validated_data</span></span><br><span class="line">            self.child.update(instance[i],attrs) <span class="keyword">for</span> i,attrs <span class="keyword">in</span> <span class="built_in">enumerate</span>(validated_data)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果序列化的是数据库的表，尽量用ModelSerializer</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookModelSerializer</span>(serializers.ModelSerializer):</span><br><span class="line">    <span class="comment"># 一种方案（只序列化可以，反序列化有问题）</span></span><br><span class="line">    <span class="comment"># publish=serializers.CharField(source=&#x27;publish.name&#x27;)</span></span><br><span class="line">    <span class="comment"># 第二种方案，models中写方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        list_serializer_class=BookListSerializer</span><br><span class="line">        model=models.Book</span><br><span class="line">        <span class="comment"># fields=&#x27;__all__&#x27;</span></span><br><span class="line">        <span class="comment"># 用的少</span></span><br><span class="line">        <span class="comment"># depth=0</span></span><br><span class="line">        fields = (<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;price&#x27;</span>,<span class="string">&#x27;authors&#x27;</span>,<span class="string">&#x27;publish&#x27;</span>,<span class="string">&#x27;publish_name&#x27;</span>,<span class="string">&#x27;author_list&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        extra_kwargs=&#123;</span><br><span class="line">            <span class="string">&#x27;publish&#x27;</span>:&#123;<span class="string">&#x27;write_only&#x27;</span>:<span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;publish_name&#x27;</span>:&#123;<span class="string">&#x27;read_only&#x27;</span>:<span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;authors&#x27;</span>:&#123;<span class="string">&#x27;write_only&#x27;</span>:<span class="literal">True</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;author_list&#x27;</span>:&#123;<span class="string">&#x27;read_only&#x27;</span>:<span class="literal">True</span>&#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># models.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(models.Model):</span><br><span class="line">    is_delete=models.BooleanField(default=<span class="literal">False</span>)</span><br><span class="line">    <span class="comment"># auto_now_add=True 只要记录创建，不需要手动插入时间，自动把当前时间插入</span></span><br><span class="line">    create_time=models.DateTimeField(auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># auto_now=True,只要更新，就会把当前时间插入</span></span><br><span class="line">    last_update_time=models.DateTimeField(auto_now=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># import datetime</span></span><br><span class="line">    <span class="comment"># create_time=models.DateTimeField(default=datetime.datetime.now)</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        <span class="comment"># 单个字段，有索引，有唯一</span></span><br><span class="line">        <span class="comment"># 多个字段，有联合索引，联合唯一</span></span><br><span class="line">        abstract=<span class="literal">True</span>  <span class="comment"># 抽象表，不再数据库建立出表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>=models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment"># verbose_name admin中显示中文</span></span><br><span class="line">    name=models.CharField(max_length=<span class="number">32</span>,verbose_name=<span class="string">&#x27;书名&#x27;</span>,help_text=<span class="string">&#x27;这里填书名&#x27;</span>)</span><br><span class="line">    price=models.DecimalField(max_digits=<span class="number">5</span>,decimal_places=<span class="number">2</span>)</span><br><span class="line">    <span class="comment"># 一对多的关系一旦确立，关联字段写在多的一方</span></span><br><span class="line">    <span class="comment">#to_field 默认不写，关联到Publish主键</span></span><br><span class="line">    <span class="comment">#db_constraint=False  逻辑上的关联，实质上没有外键练习，增删不会受外键影响，但是orm查询不影响</span></span><br><span class="line">    publish=models.ForeignKey(to=<span class="string">&#x27;Publish&#x27;</span>,on_delete=models.DO_NOTHING,db_constraint=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 多对多，跟作者，关联字段写在 查询次数多的一方</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 什么时候用自动，什么时候用手动？第三张表只有关联字段，用自动    第三张表有扩展字段，需要手动写</span></span><br><span class="line">    <span class="comment"># 不能写on_delete</span></span><br><span class="line">    authors=models.ManyToManyField(to=<span class="string">&#x27;Author&#x27;</span>,db_constraint=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        verbose_name_plural=<span class="string">&#x27;书表&#x27;</span>  <span class="comment"># admin中表名的显示</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">publish_name</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.publish.name</span><br><span class="line">    <span class="comment"># def author_list(self):</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">author_list</span>(<span class="params">self</span>):</span><br><span class="line">        author_list=self.authors.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># ll=[]</span></span><br><span class="line">        <span class="comment"># for author in author_list:</span></span><br><span class="line">        <span class="comment">#     ll.append(&#123;&#x27;name&#x27;:author.name,&#x27;sex&#x27;:author.get_sex_display()&#125;)</span></span><br><span class="line">        <span class="comment"># return ll</span></span><br><span class="line">        <span class="keyword">return</span> [ &#123;<span class="string">&#x27;name&#x27;</span>:author.name,<span class="string">&#x27;sex&#x27;</span>:author.get_sex_display()&#125;<span class="keyword">for</span> author <span class="keyword">in</span> author_list]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Publish</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    addr=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Author</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    sex=models.IntegerField(choices=((<span class="number">1</span>,<span class="string">&#x27;男&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;女&#x27;</span>)))</span><br><span class="line">    <span class="comment"># 一对一关系，写在查询频率高的一方</span></span><br><span class="line">    <span class="comment">#OneToOneField本质就是ForeignKey+unique，自己手写也可以</span></span><br><span class="line">    authordetail=models.OneToOneField(to=<span class="string">&#x27;AuthorDetail&#x27;</span>,db_constraint=<span class="literal">False</span>,on_delete=models.CASCADE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthorDetail</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    mobile=models.CharField(max_length=<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 二、表断关联</span></span><br><span class="line"><span class="comment"># 1、表之间没有外键关联，但是有外键逻辑关联(有充当外键的字段)</span></span><br><span class="line"><span class="comment"># 2、断关联后不会影响数据库查询效率，但是会极大提高数据库增删改效率（不影响增删改查操作）</span></span><br><span class="line"><span class="comment"># 3、断关联一定要通过逻辑保证表之间数据的安全，不要出现脏数据，代码控制</span></span><br><span class="line"><span class="comment"># 4、断关联</span></span><br><span class="line"><span class="comment"># 5、级联关系</span></span><br><span class="line"><span class="comment">#       作者没了，详情也没：on_delete=models.CASCADE</span></span><br><span class="line"><span class="comment">#       出版社没了，书还是那个出版社出版：on_delete=models.DO_NOTHING</span></span><br><span class="line"><span class="comment">#       部门没了，员工没有部门(空不能)：null=True, on_delete=models.SET_NULL</span></span><br><span class="line"><span class="comment">#       部门没了，员工进入默认部门(默认值)：default=0, on_delete=models.SET_DEFAULT</span></span><br></pre></td></tr></table></figure>

<h2 id="2-分页器"><a href="#2-分页器" class="headerlink" title="2. 分页器"></a>2. 分页器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#views.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查所有，才需要分页</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListAPIView</span><br><span class="line"><span class="comment"># 内置三种分页方式</span></span><br><span class="line"><span class="keyword">from</span>  rest_framework.pagination <span class="keyword">import</span> PageNumberPagination,LimitOffsetPagination,CursorPagination</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">PageNumberPagination</span></span><br><span class="line"><span class="string">    page_size:每页显示的条数</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyPageNumberPagination</span>(<span class="title class_ inherited__">PageNumberPagination</span>):</span><br><span class="line">    <span class="comment">#http://127.0.0.1:8000/api/books2/?aaa=1&amp;size=6</span></span><br><span class="line">    page_size=<span class="number">3</span>  <span class="comment">#每页条数</span></span><br><span class="line">    page_query_param=<span class="string">&#x27;aaa&#x27;</span> <span class="comment">#查询第几页的key</span></span><br><span class="line">    page_size_query_param=<span class="string">&#x27;size&#x27;</span> <span class="comment"># 每一页显示的条数</span></span><br><span class="line">    max_page_size=<span class="number">5</span>    <span class="comment"># 每页最大显示条数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># class MyLimitOffsetPagination(LimitOffsetPagination):</span></span><br><span class="line"><span class="comment">#     default_limit = 3   # 每页条数</span></span><br><span class="line"><span class="comment">#     limit_query_param = &#x27;limit&#x27; # 往后拿几条</span></span><br><span class="line"><span class="comment">#     offset_query_param = &#x27;offset&#x27; # 标杆</span></span><br><span class="line"><span class="comment">#     max_limit = 5   # 每页最大几条</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyCursorPagination</span>(<span class="title class_ inherited__">CursorPagination</span>):</span><br><span class="line">    cursor_query_param = <span class="string">&#x27;cursor&#x27;</span>  <span class="comment"># 每一页查询的key</span></span><br><span class="line">    page_size = <span class="number">2</span>   <span class="comment">#每页显示的条数</span></span><br><span class="line">    ordering = <span class="string">&#x27;-id&#x27;</span>  <span class="comment">#排序字段</span></span><br><span class="line"><span class="comment"># class BookView(ListAPIView):</span></span><br><span class="line"><span class="comment">#     # queryset = models.Book.objects.all().filter(is_delete=False)</span></span><br><span class="line"><span class="comment">#     queryset = models.Book.objects.all()</span></span><br><span class="line"><span class="comment">#     serializer_class = BookModelSerializer</span></span><br><span class="line"><span class="comment">#     #配置分页</span></span><br><span class="line"><span class="comment">#     pagination_class = MyCursorPagination</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用APIView分页</span></span><br><span class="line"><span class="keyword">from</span> utils.throttling <span class="keyword">import</span> MyThrottle</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookView</span>(<span class="title class_ inherited__">APIView</span>):</span><br><span class="line">    <span class="comment"># throttle_classes = [MyThrottle,]</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self,request,*args,**kwargs</span>):</span><br><span class="line">        book_list=models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 实例化得到一个分页器对象</span></span><br><span class="line">        page_cursor=MyPageNumberPagination()</span><br><span class="line"></span><br><span class="line">        book_list=page_cursor.paginate_queryset(book_list,request,view=self)</span><br><span class="line">        next_url =page_cursor.get_next_link()</span><br><span class="line">        pr_url=page_cursor.get_previous_link()</span><br><span class="line">        <span class="comment"># print(next_url)</span></span><br><span class="line">        <span class="comment"># print(pr_url)</span></span><br><span class="line">        book_ser=BookModelSerializer(book_list,many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(data=book_ser.data)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#settings.py</span></span><br><span class="line">REST_FRAMEWORK=&#123;</span><br><span class="line">    <span class="string">&#x27;PAGE_SIZE&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-根据ip进行频率限制"><a href="#3-根据ip进行频率限制" class="headerlink" title="3. 根据ip进行频率限制"></a>3. 根据ip进行频率限制</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 写一个类，继承SimpleRateThrottle，只需要重写get_cache_key </span></span><br><span class="line"><span class="keyword">from</span> rest_framework.throttling <span class="keyword">import</span> ScopedRateThrottle,SimpleRateThrottle</span><br><span class="line"></span><br><span class="line"><span class="comment">#继承SimpleRateThrottle</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThrottle</span>(<span class="title class_ inherited__">SimpleRateThrottle</span>):</span><br><span class="line">    scope=<span class="string">&#x27;luffy&#x27;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_key</span>(<span class="params">self, request, view</span>):</span><br><span class="line">        <span class="built_in">print</span>(request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)   <span class="comment"># 返回</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 局部使用，全局使用 </span></span><br><span class="line">REST_FRAMEWORK=&#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;utils.throttling.MyThrottle&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;luffy&#x27;</span>: <span class="string">&#x27;3/m&#x27;</span>  <span class="comment"># key要跟类中的scop对应</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># python3 manage.py runserver 0.0.0.0:8000   你们局域网就可以相互访问</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内网穿透</span></span><br></pre></td></tr></table></figure>


  </article>
  <footer class="f-cf">
    
      <a href="/2021/03/19/Pycharm%E5%AF%BC%E5%85%A5%E6%9C%AC%E5%9C%B0py%E6%96%87%E4%BB%B6%E6%97%B6%EF%BC%8C%E5%87%BA%E7%8E%B0%E7%BA%A2%E8%89%B2%E6%8A%A5%E9%94%99%E4%B8%8B%E6%BB%91%E7%BA%BF-pycharm-dao-ru-ben-de-py-wen-jian-shi--chu-xian-hong-se-bao-cuo-xia-hua-xian/" class="link f-fl">⟵Pycharm导入本地py文件时，出现红色报错下滑线</a>
    
    
      <a href="/2021/03/14/05%20Django-rest%20framework-05django-restframework/" class="link f-fr">05 Django-rest framework⟶</a>
    
  </footer>
</section></div>
    <footer id="footer" class="f-cf">
  d.guangying@foxmail.com
  
    
      
        · <a href="https://dribbble.com/clovertuan" target="_blank" class="nav-icn">Dribbble</a>
      
    
      
        · <a href="https://www.behance.net/clovertuan" target="_blank" class="nav-icn">Behance</a>
      
    
      
        · <a href="http://clovertuan.lofter.com/" target="_blank" class="nav-icn">Lofter</a>
      
    
      
        · <a href="https://www.instagram.com/clovertuan/" target="_blank" class="nav-icn">Instagram</a>
      
    
      
        · <a href="https://github.com/cloverTuan" target="_blank" class="nav-icn">GitHub</a>
      
    
  
  <span class="copyright">All rights reserved @Clover Tuan</span>
</footer>
  </div>
</body>
</html>